module.exports=[40158,a=>{"use strict";var b=a.i(22367),c=a.i(97863),d=a.i(23105),e=a.i(57372),f=a.i(45061),g=a.i(41313),h=a.i(88359),i=a.i(98138);function j(){let{db:a}=(0,d.useDatabaseStore)(),[j,k]=(0,c.useState)([]),[l,m]=(0,c.useState)(""),[n,o]=(0,c.useState)(""),[p,q]=(0,c.useState)(null),[r,s]=(0,c.useState)(!1),[t,u]=(0,c.useState)(null),[v,w]=(0,c.useState)(!1),[x,y]=(0,c.useState)(""),[z,A]=(0,c.useState)(""),[B,C]=(0,c.useState)(!1),[D,E]=(0,c.useState)(!1);(0,c.useEffect)(()=>{},[]),(0,c.useEffect)(()=>{v&&a();async function a(){try{let a=window.Database;if(a&&a.getAllDatabases){let b=await a.getAllDatabases();k(b)}}catch(a){console.error("Failed to load databases:",a)}}},[v]);let F=async()=>{if(!l||!n)return void u("Please select both source and target databases");if(l===n)return void q({tablesAdded:[],tablesRemoved:[],tablesModified:[],indexesAdded:[],indexesRemoved:[]});s(!0),u(null),q(null);try{let a=window.Database;if(!a)throw Error("Database API not available");let b=await a.newDatabase(l),c=await a.newDatabase(n),d=await b.execute("SELECT name, sql FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%' ORDER BY name"),e=await c.execute("SELECT name, sql FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%' ORDER BY name"),f=await b.execute("SELECT name, sql FROM sqlite_master WHERE type='index' AND name NOT LIKE 'sqlite_%' ORDER BY name"),g=await c.execute("SELECT name, sql FROM sqlite_master WHERE type='index' AND name NOT LIKE 'sqlite_%' ORDER BY name"),h=new Set(d.rows.map(a=>a.values[0].value)),i=new Set(e.rows.map(a=>a.values[0].value)),j=new Set(f.rows.map(a=>a.values[0].value)),k=new Set(g.rows.map(a=>a.values[0].value)),m=Array.from(i).filter(a=>!h.has(a)),o=Array.from(h).filter(a=>!i.has(a)),p=Array.from(k).filter(a=>!j.has(a)),r=Array.from(j).filter(a=>!k.has(a)),s=[];for(let a of Array.from(h).filter(a=>i.has(a)))try{let d=await b.execute(`PRAGMA table_info(${a})`),e=await c.execute(`PRAGMA table_info(${a})`),f=new Set(d.rows.map(a=>a.values[1].value)),g=new Set(e.rows.map(a=>a.values[1].value)),h=Array.from(g).filter(a=>!f.has(a)),i=Array.from(f).filter(a=>!g.has(a));(h.length>0||i.length>0)&&s.push({name:a,columnsAdded:h,columnsRemoved:i,columnsModified:[]})}catch(b){console.error(`Error comparing table ${a}:`,b)}await b.close(),await c.close(),q({tablesAdded:m,tablesRemoved:o,tablesModified:s,indexesAdded:p,indexesRemoved:r})}catch(a){console.error("[SchemaDiff] Error comparing databases:",a),u(a.message||"Failed to compare databases")}finally{s(!1)}},G=p&&(p.tablesAdded.length>0||p.tablesRemoved.length>0||p.tablesModified.length>0||p.indexesAdded.length>0||p.indexesRemoved.length>0),H=async()=>{if(p&&G){E(!0);try{let a=window.Database;if(!a)throw Error("Database API not available");let b=await a.newDatabase(n),c=await a.newDatabase(l),d=[],e=[];for(let a of(d.push("-- Forward Migration"),d.push(`-- Migrate ${l} to ${n} schema`),d.push("-- Generated: "+new Date().toISOString()),d.push(""),d.push("BEGIN TRANSACTION;"),d.push(""),e.push("-- Rollback Migration"),e.push(`-- Rollback ${n} to ${l} schema`),e.push("-- Generated: "+new Date().toISOString()),e.push(""),e.push("BEGIN TRANSACTION;"),e.push(""),p.tablesAdded))try{let c=await b.execute(`SELECT sql FROM sqlite_master WHERE type='table' AND name='${a}'`);if(c.rows.length>0){let b=c.rows[0].values[0].value;d.push(`-- Add table: ${a}`),d.push(b+";"),d.push(""),e.push(`-- Remove table: ${a}`),e.push(`DROP TABLE IF EXISTS ${a};`),e.push("")}}catch(b){console.error(`Error getting CREATE statement for ${a}:`,b)}for(let a of p.tablesRemoved)try{let b=await c.execute(`SELECT sql FROM sqlite_master WHERE type='table' AND name='${a}'`);if(b.rows.length>0){let c=b.rows[0].values[0].value;d.push(`-- Remove table: ${a}`),d.push(`DROP TABLE IF EXISTS ${a};`),d.push(""),e.push(`-- Restore table: ${a}`),e.push(c+";"),e.push("")}}catch(b){console.error(`Error getting DROP statement for ${a}:`,b)}for(let a of p.tablesModified)try{let c=await b.execute(`PRAGMA table_info(${a.name})`);for(let b of a.columnsAdded){let f=c.rows.find(a=>a.values[1].value===b);if(f){let c=f.values[2].value,g=1===f.values[3].value,h=f.values[4].value,i=`ALTER TABLE ${a.name} ADD COLUMN ${b} ${c}`;g&&(i+=" NOT NULL"),null!==h&&(i+=` DEFAULT ${h}`),d.push(`-- Add column to ${a.name}`),d.push(i+";"),d.push(""),e.push("-- Note: SQLite DROP COLUMN requires table recreation"),e.push(`-- Column ${b} was added to ${a.name}`),e.push("")}}for(let b of a.columnsRemoved)d.push(`-- Note: Removing column ${b} from ${a.name}`),d.push("-- SQLite requires table recreation for column removal"),d.push("-- Consider manual migration or backup/restore"),d.push(""),e.push(`-- Note: Column ${b} was removed from ${a.name}`),e.push("-- Would require ALTER TABLE ADD COLUMN"),e.push("")}catch(b){console.error(`Error generating ALTER statements for ${a.name}:`,b)}for(let a of p.indexesAdded)try{let c=await b.execute(`SELECT sql FROM sqlite_master WHERE type='index' AND name='${a}'`);if(c.rows.length>0&&c.rows[0].values[0].value){let b=c.rows[0].values[0].value;d.push(`-- Add index: ${a}`),d.push(b+";"),d.push(""),e.push(`-- Remove index: ${a}`),e.push(`DROP INDEX IF EXISTS ${a};`),e.push("")}}catch(b){console.error(`Error getting CREATE INDEX for ${a}:`,b)}for(let a of p.indexesRemoved)try{let b=await c.execute(`SELECT sql FROM sqlite_master WHERE type='index' AND name='${a}'`);if(b.rows.length>0&&b.rows[0].values[0].value){let c=b.rows[0].values[0].value;d.push(`-- Remove index: ${a}`),d.push(`DROP INDEX IF EXISTS ${a};`),d.push(""),e.push(`-- Restore index: ${a}`),e.push(c+";"),e.push("")}}catch(b){console.error(`Error getting DROP INDEX for ${a}:`,b)}d.push("COMMIT;"),e.push("COMMIT;"),await b.close(),await c.close(),y(d.join("\n")),A(e.join("\n")),C(!0)}catch(a){console.error("[MigrationGenerator] Error generating migration:",a),u(a.message||"Failed to generate migration")}finally{E(!1)}}},I=(a,b)=>{let c=new Blob([a],{type:"text/plain"}),d=URL.createObjectURL(c),e=document.createElement("a");e.href=d,e.download=b,document.body.appendChild(e),e.click(),document.body.removeChild(e),URL.revokeObjectURL(d)};return(0,b.jsxs)("div",{className:"container mx-auto p-6 space-y-6",children:[(0,b.jsx)("h1",{className:"text-3xl font-bold mb-6",children:"Schema Diff"}),(0,b.jsxs)(f.Card,{children:[(0,b.jsxs)(f.CardHeader,{children:[(0,b.jsx)(f.CardTitle,{children:"Compare Databases"}),(0,b.jsx)(f.CardDescription,{children:"Compare schema differences between two databases"})]}),(0,b.jsxs)(f.CardContent,{className:"space-y-4",children:[(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)("label",{htmlFor:"sourceDb",className:"text-sm font-medium",children:"Source Database"}),(0,b.jsxs)(g.Select,{value:l,onValueChange:m,children:[(0,b.jsx)(g.SelectTrigger,{id:"sourceDb",children:(0,b.jsx)(g.SelectValue,{placeholder:"Select source database"})}),(0,b.jsx)(g.SelectContent,{children:j.map(a=>(0,b.jsx)(g.SelectItem,{value:a,children:a},a))})]})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)("label",{htmlFor:"targetDb",className:"text-sm font-medium",children:"Target Database"}),(0,b.jsxs)(g.Select,{value:n,onValueChange:o,children:[(0,b.jsx)(g.SelectTrigger,{id:"targetDb",children:(0,b.jsx)(g.SelectValue,{placeholder:"Select target database"})}),(0,b.jsx)(g.SelectContent,{children:j.map(a=>(0,b.jsx)(g.SelectItem,{value:a,children:a},a))})]})]})]}),(0,b.jsx)(e.Button,{id:"compareButton",onClick:F,disabled:!l||!n||r,children:r?"Comparing...":"Compare Databases"}),t&&(0,b.jsx)(h.Alert,{variant:"destructive",children:(0,b.jsx)(h.AlertDescription,{children:t})})]})]}),p&&!G&&(0,b.jsx)(f.Card,{children:(0,b.jsx)(f.CardContent,{className:"py-8",children:(0,b.jsx)("p",{className:"text-center text-muted-foreground",children:"No differences found. The databases have identical schemas."})})}),p&&G&&(0,b.jsxs)("div",{className:"space-y-4","data-testid":"diff-summary",children:[(0,b.jsx)(f.Card,{children:(0,b.jsx)(f.CardContent,{className:"py-4",children:(0,b.jsx)(e.Button,{id:"generateMigrationButton",onClick:H,disabled:D,className:"w-full md:w-auto",children:D?"Generating...":"Generate Migration"})})}),B&&(0,b.jsxs)("div",{className:"space-y-4",children:[(0,b.jsxs)(f.Card,{children:[(0,b.jsxs)(f.CardHeader,{children:[(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsx)(f.CardTitle,{children:"Forward Migration SQL"}),(0,b.jsx)(e.Button,{id:"downloadForwardMigration",onClick:()=>{let a=new Date().toISOString().split("T")[0];I(x,`forward_migration_${a}.sql`)},variant:"outline",size:"sm",children:"Download Forward"})]}),(0,b.jsxs)(f.CardDescription,{children:["Apply these changes to migrate from ",l," to ",n]})]}),(0,b.jsx)(f.CardContent,{children:(0,b.jsx)("pre",{id:"forwardMigrationSql","data-testid":"forward-migration",className:"p-4 bg-gray-50 rounded-lg overflow-x-auto text-sm font-mono whitespace-pre",children:x})})]}),(0,b.jsxs)(f.Card,{children:[(0,b.jsxs)(f.CardHeader,{children:[(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsx)(f.CardTitle,{children:"Rollback Migration SQL"}),(0,b.jsx)(e.Button,{id:"downloadRollbackMigration",onClick:()=>{let a=new Date().toISOString().split("T")[0];I(z,`rollback_migration_${a}.sql`)},variant:"outline",size:"sm",children:"Download Rollback"})]}),(0,b.jsxs)(f.CardDescription,{children:["Use this to revert the migration and restore ",l," schema"]})]}),(0,b.jsx)(f.CardContent,{children:(0,b.jsx)("pre",{id:"rollbackMigrationSql","data-testid":"rollback-migration",className:"p-4 bg-gray-50 rounded-lg overflow-x-auto text-sm font-mono whitespace-pre",children:z})})]})]}),(0,b.jsxs)(f.Card,{children:[(0,b.jsx)(f.CardHeader,{children:(0,b.jsx)(f.CardTitle,{children:"Difference Summary"})}),(0,b.jsxs)(f.CardContent,{className:"space-y-2",children:[p.tablesAdded.length>0&&(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsxs)(i.Badge,{variant:"outline",className:"bg-green-50 text-green-700",children:["+",p.tablesAdded.length]}),(0,b.jsxs)("span",{className:"text-sm",children:[1===p.tablesAdded.length?"table":"tables"," added"]})]}),p.tablesRemoved.length>0&&(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsxs)(i.Badge,{variant:"outline",className:"bg-red-50 text-red-700",children:["-",p.tablesRemoved.length]}),(0,b.jsxs)("span",{className:"text-sm",children:[1===p.tablesRemoved.length?"table":"tables"," removed"]})]}),p.tablesModified.length>0&&(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsxs)(i.Badge,{variant:"outline",className:"bg-yellow-50 text-yellow-700",children:["~",p.tablesModified.length]}),(0,b.jsxs)("span",{className:"text-sm",children:[1===p.tablesModified.length?"table":"tables"," modified"]})]}),p.indexesAdded.length>0&&(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsxs)(i.Badge,{variant:"outline",className:"bg-green-50 text-green-700",children:["+",p.indexesAdded.length]}),(0,b.jsxs)("span",{className:"text-sm",children:[1===p.indexesAdded.length?"index":"indexes"," added"]})]}),p.indexesRemoved.length>0&&(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsxs)(i.Badge,{variant:"outline",className:"bg-red-50 text-red-700",children:["-",p.indexesRemoved.length]}),(0,b.jsxs)("span",{className:"text-sm",children:[1===p.indexesRemoved.length?"index":"indexes"," removed"]})]})]})]}),p.tablesAdded.length>0&&(0,b.jsxs)(f.Card,{children:[(0,b.jsx)(f.CardHeader,{children:(0,b.jsx)(f.CardTitle,{className:"text-green-700",children:"Tables Added"})}),(0,b.jsx)(f.CardContent,{children:(0,b.jsx)("div",{className:"space-y-2",children:p.tablesAdded.map(a=>(0,b.jsx)("div",{className:"p-3 bg-green-50 border border-green-200 rounded","data-diff":"added",children:(0,b.jsx)("span",{className:"font-mono text-sm",children:a})},a))})})]}),p.tablesRemoved.length>0&&(0,b.jsxs)(f.Card,{children:[(0,b.jsx)(f.CardHeader,{children:(0,b.jsx)(f.CardTitle,{className:"text-red-700",children:"Tables Removed"})}),(0,b.jsx)(f.CardContent,{children:(0,b.jsx)("div",{className:"space-y-2",children:p.tablesRemoved.map(a=>(0,b.jsx)("div",{className:"p-3 bg-red-50 border border-red-200 rounded","data-diff":"removed",children:(0,b.jsx)("span",{className:"font-mono text-sm",children:a})},a))})})]}),p.tablesModified.length>0&&(0,b.jsxs)(f.Card,{children:[(0,b.jsx)(f.CardHeader,{children:(0,b.jsx)(f.CardTitle,{className:"text-yellow-700",children:"Tables Modified"})}),(0,b.jsx)(f.CardContent,{children:(0,b.jsx)("div",{className:"space-y-4",children:p.tablesModified.map(a=>(0,b.jsxs)("div",{className:"p-4 bg-yellow-50 border border-yellow-200 rounded space-y-3","data-diff":"modified",children:[(0,b.jsx)("div",{className:"font-mono font-semibold",children:a.name}),a.columnsAdded.length>0&&(0,b.jsxs)("div",{className:"ml-4 space-y-1",children:[(0,b.jsx)("div",{className:"text-sm font-medium text-green-700",children:"Columns Added:"}),a.columnsAdded.map(a=>(0,b.jsxs)("div",{className:"ml-4 text-sm font-mono text-green-600",children:["+ ",a]},a))]}),a.columnsRemoved.length>0&&(0,b.jsxs)("div",{className:"ml-4 space-y-1",children:[(0,b.jsx)("div",{className:"text-sm font-medium text-red-700",children:"Columns Removed:"}),a.columnsRemoved.map(a=>(0,b.jsxs)("div",{className:"ml-4 text-sm font-mono text-red-600",children:["- ",a]},a))]})]},a.name))})})]}),p.indexesAdded.length>0&&(0,b.jsxs)(f.Card,{children:[(0,b.jsx)(f.CardHeader,{children:(0,b.jsx)(f.CardTitle,{className:"text-green-700",children:"Indexes Added"})}),(0,b.jsx)(f.CardContent,{children:(0,b.jsx)("div",{className:"space-y-2",children:p.indexesAdded.map(a=>(0,b.jsx)("div",{className:"p-3 bg-green-50 border border-green-200 rounded","data-type":"index","data-diff":"added",children:(0,b.jsx)("span",{className:"font-mono text-sm",children:a})},a))})})]}),p.indexesRemoved.length>0&&(0,b.jsxs)(f.Card,{children:[(0,b.jsx)(f.CardHeader,{children:(0,b.jsx)(f.CardTitle,{className:"text-red-700",children:"Indexes Removed"})}),(0,b.jsx)(f.CardContent,{children:(0,b.jsx)("div",{className:"space-y-2",children:p.indexesRemoved.map(a=>(0,b.jsx)("div",{className:"p-3 bg-red-50 border border-red-200 rounded","data-type":"index","data-diff":"removed",children:(0,b.jsx)("span",{className:"font-mono text-sm",children:a})},a))})})]})]})]})}function k(){return(0,d.useDatabaseStore)(a=>a.currentDbName),(0,b.jsx)(j,{})}a.s(["default",()=>k])}];

//# sourceMappingURL=pwa_app_db_diff_page_tsx_d4c04601._.js.map