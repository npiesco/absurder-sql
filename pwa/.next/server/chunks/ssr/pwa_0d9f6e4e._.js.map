{"version":3,"sources":["turbopack:///[project]/pwa/node_modules/next/src/server/route-modules/app-page/vendored/ssr/react-jsx-runtime.ts","turbopack:///[project]/pwa/lib/db/client.ts","turbopack:///[project]/pwa/app/test/page.tsx"],"sourcesContent":["module.exports = (\n  require('../../module.compiled') as typeof import('../../module.compiled')\n).vendored['react-ssr']!.ReactJsxRuntime\n","import init, { Database, type QueryResult } from '@npiesco/absurder-sql';\n\nexport type { QueryResult };\n\nexport class DatabaseClient {\n  private db: Database | null = null;\n  private dbName: string | null = null;\n  private initialized: boolean = false;\n\n  /**\n   * Initialize the WASM module. This must be called before any database operations.\n   * Safe to call multiple times - will only initialize once.\n   */\n  async initialize(): Promise<void> {\n    if (this.initialized) {\n      return;\n    }\n\n    try {\n      await init();\n      this.initialized = true;\n    } catch (error) {\n      console.error('Failed to initialize WASM module:', error);\n      throw new Error(`WASM initialization failed: ${error}`);\n    }\n  }\n\n  /**\n   * Check if WASM module is initialized\n   */\n  isInitialized(): boolean {\n    return this.initialized;\n  }\n\n  /**\n   * Open a database by name. Creates a new database if it doesn't exist.\n   * @param dbName - Name of the database file (e.g., 'myapp.db')\n   */\n  async open(dbName: string): Promise<void> {\n    await this.initialize();\n\n    if (this.db) {\n      throw new Error('Database is already open. Close it first.');\n    }\n\n    try {\n      this.db = await Database.newDatabase(dbName);\n      this.dbName = dbName;\n      console.log(`DatabaseClient: Opened database \"${dbName}\"`);\n    } catch (error) {\n      console.error('DatabaseClient: Failed to open database:', error);\n      throw new Error(`Failed to open database: ${error}`);\n    }\n  }\n\n  /**\n   * Execute a SQL query with optional parameters\n   * @param sql - SQL query string\n   * @param params - Optional array of parameters for prepared statement\n   */\n  async execute(sql: string, params?: any[]): Promise<QueryResult> {\n    if (!this.db) {\n      throw new Error('Database not opened. Call open() first.');\n    }\n\n    try {\n      if (params && params.length > 0) {\n        return await this.db.executeWithParams(sql, params);\n      } else {\n        return await this.db.execute(sql);\n      }\n    } catch (error) {\n      console.error('Query execution failed:', error);\n      throw new Error(`Query failed: ${error}`);\n    }\n  }\n\n  /**\n   * Export database to a Blob (downloadable .db file)\n   */\n  async export(): Promise<Blob> {\n    if (!this.db) {\n      throw new Error('Database not opened. Call open() first.');\n    }\n\n    try {\n      const buffer = await this.db.exportToFile();\n      return new Blob([buffer as BlobPart], { type: 'application/x-sqlite3' });\n    } catch (error) {\n      console.error('Database export failed:', error);\n      throw new Error(`Export failed: ${error}`);\n    }\n  }\n\n  /**\n   * Import a database from a File\n   * Note: This closes the current database connection and reopens it with the imported data\n   * @param file - File object containing SQLite database\n   */\n  async import(file: File): Promise<void> {\n    if (!this.db || !this.dbName) {\n      throw new Error('Database not opened. Call open() first to create initial database instance.');\n    }\n\n    try {\n      const buffer = await file.arrayBuffer();\n      await this.db.importFromFile(new Uint8Array(buffer));\n      \n      // importFromFile closes the connection, must reopen with same name\n      console.log(`Import complete, reopening database \"${this.dbName}\"...`);\n      this.db = await Database.newDatabase(this.dbName);\n      console.log('Database reopened after import');\n    } catch (error) {\n      console.error('Database import failed:', error);\n      throw new Error(`Import failed: ${error}`);\n    }\n  }\n\n  /**\n   * Sync database to IndexedDB (flush WAL)\n   * Call this after writes to ensure data is persisted\n   */\n  async sync(): Promise<void> {\n    if (!this.db) {\n      throw new Error('Database not opened. Call open() first.');\n    }\n    try {\n      await this.db.sync();\n    } catch (error) {\n      console.error('Database sync failed:', error);\n      throw new Error(`Sync failed: ${error}`);\n    }\n  }\n\n  /**\n   * Close the database connection\n   */\n  async close(): Promise<void> {\n    if (this.db) {\n      try {\n        await this.db.close();\n        this.db = null;\n        this.dbName = null;\n      } catch (error) {\n        console.error('Database close failed:', error);\n        throw new Error(`Close failed: ${error}`);\n      }\n    }\n  }\n\n  /**\n   * Check if database is currently open\n   */\n  isOpen(): boolean {\n    return this.db !== null;\n  }\n\n  /**\n   * Get the current database name\n   */\n  getDatabaseName(): string | null {\n    return this.dbName;\n  }\n\n  /**\n   * Export database to a Blob with specified name\n   * Alias for export() method to match common naming conventions\n   */\n  async exportDatabase(): Promise<Blob> {\n    return this.export();\n  }\n\n  /**\n   * Import database from a Blob with a new database name\n   * Creates a new database and imports the data\n   */\n  async importDatabase(dbName: string, blob: Blob): Promise<void> {\n    await this.initialize();\n\n    // Close existing database if open\n    if (this.db) {\n      await this.close();\n    }\n\n    try {\n      // Create new database\n      this.db = await Database.newDatabase(dbName);\n      this.dbName = dbName;\n\n      // Import data\n      const buffer = await blob.arrayBuffer();\n      await this.db.importFromFile(new Uint8Array(buffer));\n      \n      // importFromFile closes the connection, must reopen\n      console.log(`Import complete, reopening database \"${dbName}\"...`);\n      this.db = await Database.newDatabase(dbName);\n      console.log('Database reopened after import');\n    } catch (error) {\n      console.error('Database import failed:', error);\n      this.db = null;\n      this.dbName = null;\n      throw new Error(`Import failed: ${error}`);\n    }\n  }\n\n  /**\n   * Delete a database by name\n   * Warning: This permanently removes the database from IndexedDB\n   */\n  async deleteDatabase(dbName: string): Promise<void> {\n    await this.initialize();\n\n    // Close if this is the current database\n    if (this.dbName === dbName && this.db) {\n      await this.close();\n    }\n\n    try {\n      // Delete from IndexedDB directly\n      const deleteRequest = indexedDB.deleteDatabase(dbName);\n      \n      await new Promise<void>((resolve, reject) => {\n        deleteRequest.onsuccess = () => {\n          console.log(`Deleted database \"${dbName}\"`);\n          resolve();\n        };\n        deleteRequest.onerror = () => {\n          reject(new Error(`Failed to delete database: ${deleteRequest.error}`));\n        };\n        deleteRequest.onblocked = () => {\n          console.warn(`Delete blocked for database \"${dbName}\". Close all connections first.`);\n        };\n      });\n    } catch (error) {\n      console.error(`Failed to delete database \"${dbName}\":`, error);\n      throw new Error(`Delete failed: ${error}`);\n    }\n  }\n\n  /**\n   * Get the current database instance (for advanced use)\n   */\n  getDatabase(): Database | null {\n    return this.db;\n  }\n\n  /**\n   * Check if this instance is the leader (can write to database)\n   */\n  async isLeader(): Promise<boolean> {\n    if (!this.db) {\n      throw new Error('Database not opened. Call open() first.');\n    }\n    return await this.db.isLeader();\n  }\n\n  /**\n   * Wait for this instance to become leader\n   */\n  async waitForLeadership(): Promise<void> {\n    if (!this.db) {\n      throw new Error('Database not opened. Call open() first.');\n    }\n    return await this.db.waitForLeadership();\n  }\n\n  /**\n   * Request leadership (triggers re-election)\n   */\n  async requestLeadership(): Promise<void> {\n    if (!this.db) {\n      throw new Error('Database not opened. Call open() first.');\n    }\n    return await this.db.requestLeadership();\n  }\n\n  /**\n   * Allow non-leader writes (for single-tab apps or testing)\n   */\n  async allowNonLeaderWrites(allow: boolean): Promise<void> {\n    if (!this.db) {\n      throw new Error('Database not opened. Call open() first.');\n    }\n    return await this.db.allowNonLeaderWrites(allow);\n  }\n}\n","'use client';\n\nimport { useEffect, useState } from 'react';\nimport { DatabaseClient } from '@/lib/db/client';\n\nexport default function TestPage() {\n  const [status, setStatus] = useState('Initializing...');\n  const [db, setDb] = useState<DatabaseClient | null>(null);\n\n  useEffect(() => {\n    async function initDb() {\n      try {\n        const client = new DatabaseClient();\n        await client.initialize();\n        await client.open('test_pwa.db');\n        \n        // Expose on window for Playwright tests\n        (window as any).dbClient = client;\n        \n        setDb(client);\n        setStatus('Database ready');\n      } catch (err) {\n        setStatus(`Error: ${err}`);\n      }\n    }\n    \n    initDb();\n  }, []);\n\n  const runTest = async () => {\n    if (!db) return;\n    \n    try {\n      setStatus('Running test...');\n      \n      // Create table\n      await db.execute('CREATE TABLE IF NOT EXISTS test (id INTEGER PRIMARY KEY, name TEXT)');\n      \n      // Insert data\n      await db.execute('INSERT INTO test (id, name) VALUES (?, ?)', [\n        { type: 'Integer', value: 1 },\n        { type: 'Text', value: 'PWA Test' }\n      ]);\n      \n      // Query data\n      const result = await db.execute('SELECT * FROM test');\n      \n      setStatus(`Test passed! Rows: ${result.rows.length}`);\n    } catch (err) {\n      setStatus(`Test failed: ${err}`);\n    }\n  };\n\n  return (\n    <div style={{ padding: '20px', fontFamily: 'system-ui' }}>\n      <h1>PWA Database Test</h1>\n      <p id=\"status\">{status}</p>\n      <button id=\"runTest\" onClick={runTest} disabled={!db}>\n        Run Test\n      </button>\n    </div>\n  );\n}\n"],"names":["module","exports","require","vendored","ReactJsxRuntime"],"mappings":"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","ignoreList":[0]}