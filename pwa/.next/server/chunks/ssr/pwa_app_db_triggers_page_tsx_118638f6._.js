module.exports=[56553,a=>{"use strict";var b=a.i(22367),c=a.i(97863),d=a.i(23105),e=a.i(57372),f=a.i(5193),g=a.i(28927),h=a.i(45061),i=a.i(88762);function j(){let{db:a,setDb:j,currentDbName:k,setCurrentDbName:l}=(0,d.useDatabaseStore)(),[m,n]=(0,c.useState)([]),[o,p]=(0,c.useState)([]),[q,r]=(0,c.useState)(!0),[s,t]=(0,c.useState)(!1),[u,v]=(0,c.useState)(""),[w,x]=(0,c.useState)(!1),[y,z]=(0,c.useState)(""),[A,B]=(0,c.useState)("AFTER"),[C,D]=(0,c.useState)("INSERT"),[E,F]=(0,c.useState)(""),[G,H]=(0,c.useState)(""),[I,J]=(0,c.useState)(!1),[K,L]=(0,c.useState)(null),[M,N]=(0,c.useState)(!1),[O,P]=(0,c.useState)(null),[Q,R]=(0,c.useState)(""),[S,T]=(0,c.useState)("AFTER"),[U,V]=(0,c.useState)("INSERT"),[W,X]=(0,c.useState)(""),[Y,Z]=(0,c.useState)("");(0,c.useEffect)(()=>{},[a,j,k,l]);let $=async()=>{if(!a)return void console.error("[TriggersPage] loadTriggers called but db is null");console.log("[TriggersPage] loadTriggers called");try{t(!0),v("");let b=await a.execute("SELECT name, tbl_name, sql FROM sqlite_master WHERE type='trigger' ORDER BY name");console.log("[TriggersPage] Loaded triggers:",b.rows.length),n(b.rows.map(a=>({name:a.values[0].value,tbl_name:a.values[1].value,sql:a.values[2].value})))}catch(a){console.error("[TriggersPage] Error loading triggers:",a),v(`Failed to load triggers: ${a}`)}finally{t(!1)}},_=async()=>{if(a)try{let b=(await a.execute("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%' ORDER BY name")).rows.map(a=>a.values[0].value);p(b)}catch(a){console.error("[TriggersPage] Error loading tables:",a)}};(0,c.useEffect)(()=>{a&&!q&&($(),_(),window.loadTriggers=$,window.loadTables=_)},[a,q]);let aa=a=>{try{let b=a.match(/CREATE\s+TRIGGER\s+(\w+)/i),c=a.match(/\s+(BEFORE|AFTER)\s+/i),d=a.match(/\s+(INSERT|UPDATE|DELETE)\s+/i),e=a.match(/\s+ON\s+(\w+)/i),f=a.match(/BEGIN\s+([\s\S]+)\s+END/i);if(!b||!c||!d||!e||!f)return null;return{name:b[1],timing:c[1].toUpperCase(),event:d[1].toUpperCase(),table:e[1],body:f[1].trim()}}catch(a){return console.error("[TriggersPage] Error parsing trigger SQL:",a),null}},ab=async()=>{if(a){if(v(""),!y.trim())return void v("Trigger name is required");if(!E.trim())return void v("Table must be selected");if(!G.trim())return void v("Trigger body is required");if(m.find(a=>a.name.toLowerCase()===y.toLowerCase()))return void v(`Trigger "${y}" already exists`);try{t(!0);let b=`CREATE TRIGGER ${y}
${A} ${C} ON ${E}
BEGIN
  ${G}
END`;console.log("[TriggersPage] Creating trigger with SQL:",b),await a.execute(b),await a.sync(),console.log("[TriggersPage] Trigger created successfully"),x(!1),z(""),B("AFTER"),D("INSERT"),F(""),H(""),await $()}catch(a){console.error("[TriggersPage] Error creating trigger:",a),v(`Failed to create trigger: ${a}`)}finally{t(!1)}}},ac=async()=>{if(a&&K){v("");try{t(!0),console.log("[TriggersPage] Dropping trigger:",K),await a.execute(`DROP TRIGGER ${K}`),await a.sync(),console.log("[TriggersPage] Trigger dropped successfully"),J(!1),L(null),await $()}catch(a){console.error("[TriggersPage] Error dropping trigger:",a),v(`Failed to drop trigger: ${a}`)}finally{t(!1)}}},ad=async()=>{if(a&&O){if(v(""),!Q.trim())return void v("Trigger name is required");if(!W.trim())return void v("Table must be selected");if(!Y.trim())return void v("Trigger body is required");if(Q!==O.name&&m.find(a=>a.name.toLowerCase()===Q.toLowerCase()))return void v(`Trigger "${Q}" already exists`);try{t(!0),await a.execute("BEGIN TRANSACTION");try{console.log("[TriggersPage] Dropping old trigger:",O.name),await a.execute(`DROP TRIGGER ${O.name}`);let b=`CREATE TRIGGER ${Q}
${S} ${U} ON ${W}
BEGIN
  ${Y}
END`;console.log("[TriggersPage] Creating updated trigger with SQL:",b),await a.execute(b),await a.execute("COMMIT"),await a.sync(),console.log("[TriggersPage] Trigger edited successfully"),N(!1),P(null),R(""),T("AFTER"),V("INSERT"),X(""),Z(""),await $()}catch(b){throw console.error("[TriggersPage] Error during trigger edit, rolling back:",b),await a.execute("ROLLBACK"),b}}catch(a){console.error("[TriggersPage] Error editing trigger:",a),v(`Failed to edit trigger: ${a}`)}finally{t(!1)}}};return q?(0,b.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,b.jsx)("p",{children:"Initializing database..."})}):(0,b.jsxs)("div",{className:"p-6 space-y-4",children:[(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("h1",{className:"text-3xl font-bold",children:"Triggers Management"}),(0,b.jsxs)("p",{className:"text-muted-foreground mt-1",children:[m.length," ",1===m.length?"trigger":"triggers"]})]}),(0,b.jsx)(e.Button,{onClick:()=>x(!0),children:"Create Trigger"})]}),u&&(0,b.jsx)("div",{className:"bg-destructive/10 text-destructive px-4 py-3 rounded","data-testid":"error-message",children:u}),s&&(0,b.jsx)("div",{className:"text-muted-foreground",children:"Loading..."}),0!==m.length||s?(0,b.jsx)("div",{className:"grid gap-4",children:m.map(a=>{let c=aa(a.sql);return(0,b.jsxs)(h.Card,{"data-trigger-card":a.name,children:[(0,b.jsx)(h.CardHeader,{children:(0,b.jsxs)("div",{className:"flex items-start justify-between",children:[(0,b.jsxs)("div",{className:"flex-1",children:[(0,b.jsx)(h.CardTitle,{"data-slot":"card-title",children:a.name}),(0,b.jsx)(h.CardDescription,{className:"mt-1",children:c?(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)("span",{className:"font-medium",children:c.timing})," ",(0,b.jsx)("span",{className:"font-medium",children:c.event})," on ",(0,b.jsx)("span",{className:"font-medium",children:c.table})]}):`On ${a.tbl_name}`})]}),(0,b.jsxs)("div",{className:"flex gap-2",children:[(0,b.jsx)(e.Button,{variant:"outline",size:"sm",onClick:()=>{let b;!(b=aa(a.sql))?v("Failed to parse trigger SQL for editing"):(P(b),R(b.name),T(b.timing),V(b.event),X(b.table),Z(b.body),N(!0))},children:"Edit"}),(0,b.jsx)(e.Button,{variant:"destructive",size:"sm",onClick:()=>{L(a.name),J(!0)},children:"Drop"})]})]})}),(0,b.jsx)(h.CardContent,{children:(0,b.jsx)("div",{className:"bg-muted p-3 rounded text-sm font-mono overflow-x-auto","data-trigger-sql":!0,children:a.sql})})]},a.name)})}):(0,b.jsx)("div",{className:"text-center py-12 text-muted-foreground",children:"No triggers found. Create one to get started."}),(0,b.jsx)(i.Dialog,{open:w,onOpenChange:x,children:(0,b.jsxs)(i.DialogContent,{className:"max-w-2xl",children:[(0,b.jsxs)(i.DialogHeader,{children:[(0,b.jsx)(i.DialogTitle,{children:"Create Trigger"}),(0,b.jsx)(i.DialogDescription,{children:"Create a new database trigger"})]}),(0,b.jsxs)("div",{className:"space-y-4",children:[u&&(0,b.jsx)("div",{className:"bg-destructive/10 text-destructive px-4 py-3 rounded text-sm","data-testid":"dialog-error-message",children:u}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{htmlFor:"triggerName",className:"text-sm font-medium",children:"Trigger Name"}),(0,b.jsx)(f.Input,{id:"triggerName",value:y,onChange:a=>z(a.target.value),placeholder:"my_trigger"})]}),(0,b.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{htmlFor:"triggerTiming",className:"text-sm font-medium",children:"Timing"}),(0,b.jsxs)("select",{id:"triggerTiming",value:A,onChange:a=>B(a.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring",children:[(0,b.jsx)("option",{value:"BEFORE",children:"BEFORE"}),(0,b.jsx)("option",{value:"AFTER",children:"AFTER"})]})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{htmlFor:"triggerEvent",className:"text-sm font-medium",children:"Event"}),(0,b.jsxs)("select",{id:"triggerEvent",value:C,onChange:a=>D(a.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring",children:[(0,b.jsx)("option",{value:"INSERT",children:"INSERT"}),(0,b.jsx)("option",{value:"UPDATE",children:"UPDATE"}),(0,b.jsx)("option",{value:"DELETE",children:"DELETE"})]})]})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{htmlFor:"triggerTable",className:"text-sm font-medium",children:"Table"}),(0,b.jsxs)("select",{id:"triggerTable",value:E,onChange:a=>F(a.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring",children:[(0,b.jsx)("option",{value:"",children:"Select a table..."}),o.map(a=>(0,b.jsx)("option",{value:a,children:a},a))]})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{htmlFor:"triggerBody",className:"text-sm font-medium",children:"Trigger Body (SQL between BEGIN and END)"}),(0,b.jsx)(g.Textarea,{id:"triggerBody",value:G,onChange:a=>H(a.target.value),placeholder:"INSERT INTO audit_log (action) VALUES ('something');",rows:8,className:"font-mono text-sm"})]})]}),(0,b.jsxs)(i.DialogFooter,{children:[(0,b.jsx)(e.Button,{variant:"outline",onClick:()=>x(!1),children:"Cancel"}),(0,b.jsx)(e.Button,{id:"confirmCreateTrigger",onClick:ab,disabled:s,children:s?"Creating...":"Create Trigger"})]})]})}),(0,b.jsx)(i.Dialog,{open:M,onOpenChange:N,children:(0,b.jsxs)(i.DialogContent,{className:"max-w-2xl",children:[(0,b.jsxs)(i.DialogHeader,{children:[(0,b.jsx)(i.DialogTitle,{children:"Edit Trigger"}),(0,b.jsx)(i.DialogDescription,{children:"Edit the trigger (will drop and recreate)"})]}),(0,b.jsxs)("div",{className:"space-y-4",children:[u&&(0,b.jsx)("div",{className:"bg-destructive/10 text-destructive px-4 py-3 rounded text-sm","data-testid":"dialog-error-message",children:u}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{htmlFor:"editTriggerName",className:"text-sm font-medium",children:"Trigger Name"}),(0,b.jsx)(f.Input,{id:"editTriggerName",value:Q,onChange:a=>R(a.target.value),placeholder:"my_trigger"})]}),(0,b.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{htmlFor:"editTriggerTiming",className:"text-sm font-medium",children:"Timing"}),(0,b.jsxs)("select",{id:"editTriggerTiming",value:S,onChange:a=>T(a.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring",children:[(0,b.jsx)("option",{value:"BEFORE",children:"BEFORE"}),(0,b.jsx)("option",{value:"AFTER",children:"AFTER"})]})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{htmlFor:"editTriggerEvent",className:"text-sm font-medium",children:"Event"}),(0,b.jsxs)("select",{id:"editTriggerEvent",value:U,onChange:a=>V(a.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring",children:[(0,b.jsx)("option",{value:"INSERT",children:"INSERT"}),(0,b.jsx)("option",{value:"UPDATE",children:"UPDATE"}),(0,b.jsx)("option",{value:"DELETE",children:"DELETE"})]})]})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{htmlFor:"editTriggerTable",className:"text-sm font-medium",children:"Table"}),(0,b.jsxs)("select",{id:"editTriggerTable",value:W,onChange:a=>X(a.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring",children:[(0,b.jsx)("option",{value:"",children:"Select a table..."}),o.map(a=>(0,b.jsx)("option",{value:a,children:a},a))]})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{htmlFor:"editTriggerBody",className:"text-sm font-medium",children:"Trigger Body (SQL between BEGIN and END)"}),(0,b.jsx)(g.Textarea,{id:"editTriggerBody",value:Y,onChange:a=>Z(a.target.value),placeholder:"INSERT INTO audit_log (action) VALUES ('something');",rows:8,className:"font-mono text-sm"})]})]}),(0,b.jsxs)(i.DialogFooter,{children:[(0,b.jsx)(e.Button,{variant:"outline",onClick:()=>N(!1),children:"Cancel"}),(0,b.jsx)(e.Button,{id:"confirmEditTrigger",onClick:ad,disabled:s,children:s?"Saving...":"Save Changes"})]})]})}),(0,b.jsx)(i.Dialog,{open:I,onOpenChange:J,children:(0,b.jsxs)(i.DialogContent,{children:[(0,b.jsxs)(i.DialogHeader,{children:[(0,b.jsx)(i.DialogTitle,{children:"Drop Trigger"}),(0,b.jsxs)(i.DialogDescription,{children:['Are you sure you want to drop the trigger "',K,'"? This action cannot be undone.']})]}),(0,b.jsxs)(i.DialogFooter,{children:[(0,b.jsx)(e.Button,{variant:"outline",onClick:()=>J(!1),children:"Cancel"}),(0,b.jsx)(e.Button,{variant:"destructive",onClick:ac,disabled:s,children:s?"Dropping...":"Drop Trigger"})]})]})})]})}a.s(["default",()=>j])}];

//# sourceMappingURL=pwa_app_db_triggers_page_tsx_118638f6._.js.map