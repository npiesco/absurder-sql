<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Working WASM Tests</title>
    <style>
        body { font-family: sans-serif; margin: 20px; line-height: 1.6; }
        .test-results { margin: 20px 0; }
        .pass { color: green; }
        .fail { color: red; }
        .info { color: blue; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>Working WASM Tests</h1>
    <div id="results"></div>
    <pre id="console-output"></pre>

    <script type="module">
        import init, { WasmColumnValue } from './pkg/sqlite_indexeddb_rs.js';

        const results = document.getElementById('results');
        const consoleOutput = document.getElementById('console-output');
        
        let testsRun = 0;
        let testsPassed = 0;
        let testsFailed = 0;

        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.textContent = message;
            results.appendChild(div);
            
            consoleOutput.textContent += message + '\n';
            console.log(message);
        }

        function logPass(message) {
            testsPassed++;
            log(`✓ ${message}`, 'pass');
        }

        function logFail(message) {
            testsFailed++;
            log(`✗ ${message}`, 'fail');
        }

        async function test_bigint_handling() {
            testsRun++;
            try {
                console.log("Starting BigInt test");
                
                // Test creating a BigInt from string directly
                const bigIntStr = WasmColumnValue.createBigInt("9007199254740993"); // 2^53 + 1
                console.log("Created BigInt from string directly");
                
                // Test creating a BigInt from string via fromJsValue
                const bigIntAsString = "9007199254740993";
                console.log(`Testing fromJsValue with string: ${bigIntAsString}`);
                const bigIntFromString = WasmColumnValue.fromJsValue(bigIntAsString);
                console.log("Successfully converted string to BigInt via fromJsValue");
                
                // Test very large integer
                const veryLargeInt = "123456789012345678901234567890";
                console.log(`Testing very large integer: ${veryLargeInt}`);
                const largeIntValue = WasmColumnValue.fromJsValue(veryLargeInt);
                console.log("Successfully handled very large integer");
                
                logPass("BigInt handling test passed");
            } catch (error) {
                logFail(`BigInt handling test failed: ${error.message}`);
                console.error(error);
            }
        }
        
        async function test_date_handling() {
            testsRun++;
            try {
                console.log("Starting Date test");
                
                // Test creating a Date from timestamp
                const now = Date.now();
                console.log(`Testing createDate with timestamp: ${now}`);
                const dateFromTimestamp = WasmColumnValue.createDate(now);
                console.log("Created Date from timestamp directly");
                
                // Test creating a Date from JS Date object via fromJsValue
                const jsDate = new Date();
                console.log(`Testing fromJsValue with Date object: ${jsDate.toISOString()}`);
                const dateFromJsDate = WasmColumnValue.fromJsValue(jsDate);
                console.log("Successfully converted JS Date to WasmColumnValue via fromJsValue");
                
                // Test ISO string date
                const isoDate = "2025-08-15T12:30:45.000Z";
                console.log(`Testing ISO date string: ${isoDate}`);
                const dateFromIso = WasmColumnValue.fromJsValue(isoDate);
                console.log("Successfully converted ISO date string to Date");
                
                logPass("Date handling test passed");
            } catch (error) {
                logFail(`Date handling test failed: ${error.message}`);
                console.error(error);
            }
        }

        async function test_mixed_types() {
            testsRun++;
            try {
                console.log("Testing mixed data types");
                
                // Test all basic types
                const nullVal = WasmColumnValue.createNull();
                const intVal = WasmColumnValue.createInteger(42);
                const realVal = WasmColumnValue.createReal(3.14159);
                const textVal = WasmColumnValue.createText("Hello SQLite");
                const blobVal = WasmColumnValue.createBlob(new Uint8Array([1, 2, 3, 4]));
                const bigIntVal = WasmColumnValue.createBigInt("9007199254740993");
                const dateVal = WasmColumnValue.createDate(Date.now());
                
                console.log("Created all data types successfully");
                
                // Test fromJsValue with various types
                const fromNull = WasmColumnValue.fromJsValue(null);
                const fromNumber = WasmColumnValue.fromJsValue(123);
                const fromFloat = WasmColumnValue.fromJsValue(2.718);
                const fromString = WasmColumnValue.fromJsValue("Test string");
                const fromDate = WasmColumnValue.fromJsValue(new Date());
                const fromBigIntStr = WasmColumnValue.fromJsValue("999999999999999999999");
                
                console.log("Converted all JS types successfully");
                
                logPass("Mixed data types test passed");
            } catch (error) {
                logFail(`Mixed data types test failed: ${error.message}`);
                console.error(error);
            }
        }

        async function test_wasm_column_value_creation() {
            testsRun++;
            try {
                console.log("Testing WasmColumnValue creation and conversion");
                
                // Test all the basic creation methods
                const tests = [
                    () => WasmColumnValue.createNull(),
                    () => WasmColumnValue.createInteger(42),
                    () => WasmColumnValue.createReal(3.14159),
                    () => WasmColumnValue.createText("Hello World"),
                    () => WasmColumnValue.createBlob(new Uint8Array([1, 2, 3, 4])),
                    () => WasmColumnValue.createBigInt("9007199254740993"),
                    () => WasmColumnValue.createDate(Date.now())
                ];
                
                for (let i = 0; i < tests.length; i++) {
                    tests[i]();
                    console.log(`Test ${i + 1} passed`);
                }
                
                logPass("WasmColumnValue creation test passed");
                
            } catch (error) {
                logFail(`WasmColumnValue creation test failed: ${error.message}`);
                console.error(error);
            }
        }

        async function runAllTests() {
            log("Initializing WASM module...", 'info');
            
            try {
                await init();
                log("WASM module initialized successfully", 'info');
                
                log("Running BigInt and Date handling tests...", 'info');
                
                await test_bigint_handling();
                await test_date_handling();
                await test_mixed_types();
                await test_wasm_column_value_creation();
                
                log(`\nTest Summary: ${testsPassed}/${testsRun} tests passed`, 
                    testsFailed === 0 ? 'pass' : 'fail');
                
            } catch (error) {
                logFail(`Failed to initialize WASM: ${error}`);
                console.error(error);
            }
        }

        // Run tests automatically
        runAllTests();
    </script>
</body>
</html>
